generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  // url moved to prisma.config.ts for Prisma 7
}

model User {
  id                      String                 @id @default(cuid())
  name                    String?
  email                   String?                @unique
  emailVerified           DateTime?
  image                   String?
  password                String?
  isTwoFactorEnabled      Boolean                @default(false)
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  lastLoginAt             DateTime?
  isActive                Boolean                @default(true)
  roleId                  String?
  notificationPreferences Json?
  invitedBy               String?
  accounts                Account[]
  adminNotifications      AdminNotification[]
  auditLogs               AuditLog[]
  createdNews             News[]                 @relation("NewsCreator")
  updatedNews             News[]                 @relation("NewsUpdater")
  twoFactorConfirmation   TwoFactorConfirmation?
  inviter                 User?                  @relation("UserInvitedBy", fields: [invitedBy], references: [id])
  invitedUsers            User[]                 @relation("UserInvitedBy")
  role                    Role?                  @relation(fields: [roleId], references: [id])
  invitationsSent         UserInvitation[]       @relation("UserInviter")

  @@index([email])
  @@index([roleId])
  @@index([isActive])
  @@index([invitedBy], map: "User_invitedBy_fkey")
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model VerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, token])
  @@index([email])
  @@index([expires])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, token])
  @@index([email])
  @@index([expires])
}

model TwoFactorToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, token])
  @@index([email])
  @@index([expires])
}

model TwoFactorConfirmation {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       User[]
  invitations UserInvitation[]
}

model Permission {
  id          String           @id @default(cuid())
  name        String           @unique
  resource    String
  action      String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]

  @@unique([resource, action])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId], map: "RolePermission_permissionId_fkey")
}

model UserInvitation {
  id         String    @id @default(cuid())
  email      String
  token      String    @unique
  roleId     String
  invitedBy  String
  status     String    @default("PENDING")
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  acceptedAt DateTime?
  acceptedBy String?
  inviter    User      @relation("UserInviter", fields: [invitedBy], references: [id])
  role       Role      @relation(fields: [roleId], references: [id])

  @@index([invitedBy], map: "UserInvitation_invitedBy_fkey")
  @@index([roleId], map: "UserInvitation_roleId_fkey")
}

model Image {
  id            String          @id @default(cuid())
  filename      String?
  originalName  String?
  url           String? // S3 public URL
  s3Key         String? // S3 object key
  s3Bucket      String? // S3 bucket name
  mimeType      String?
  size          Int?
  width         Int?
  height        Int?
  alt           String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  collaborators Collaborator[]
  innovators    Innovator[]
  news          News[]
  StrategicPlan StrategicPlan[]

  @@index([filename])
  @@index([mimeType])
  @@index([s3Key])
}

model Media {
  id                         String                       @id @default(cuid())
  filename                   String?
  originalName               String?
  url                        String? // S3 public URL
  s3Key                      String? // S3 object key
  s3Bucket                   String? // S3 bucket name
  mimeType                   String?
  size                       Int?
  duration                   Int?
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  experienceProvidedMedia    ExperienceProvidedMedia[]
  innovatorProjectFiles      InnovatorProjectFile[]
  machineryAndEquipmentMedia MachineryAndEquipmentMedia[]

  @@index([filename])
  @@index([mimeType])
  @@index([s3Key])
}

model News {
  id              String    @id @default(cuid())
  title           String
  titleEn         String?
  slug            String    @unique
  content         String    @db.Text
  contentEn       String?   @db.Text
  excerpt         String?   @db.Text
  excerptEn       String?   @db.Text
  tags            String?   @db.Text // Comma-separated tags
  duration        String?
  isActive        Boolean   @default(true)
  isFeatured      Boolean   @default(false)
  publishedAt     DateTime?
  imageId         String?
  galleryIds      String?   @db.Text
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdById     String?
  updatedById     String?
  createdBy       User?     @relation("NewsCreator", fields: [createdById], references: [id])
  image           Image?    @relation(fields: [imageId], references: [id])
  updatedBy       User?     @relation("NewsUpdater", fields: [updatedById], references: [id])

  @@index([slug])
  @@index([isActive, publishedAt])
  @@index([isFeatured])
  @@index([createdAt])
  @@index([createdById], map: "News_createdById_fkey")
  @@index([imageId], map: "News_imageId_fkey")
  @@index([updatedById], map: "News_updatedById_fkey")
}

model StrategicPlan {
  id              String       @id @default(cuid())
  title           String // title in English
  titleAr         String? // title in Arabic
  slug            String       @unique
  content         String       @db.Text // content in English
  contentAr       String?      @db.Text // content in Arabic
  excerpt         String?      @db.Text
  excerptAr       String?      @db.Text
  category        String?
  categoryAr      String?
  priority        PlanPriority @default(MEDIUM)
  status          PlanStatus   @default(DRAFT)
  isActive        Boolean      @default(true)
  progress        Int          @default(0) // 0-100
  phase           String? // phase in English (e.g., "Execution")
  phaseAr         String? // phase in Arabic
  publishedAt     DateTime?
  startDate       DateTime?
  endDate         DateTime?
  imageId         String?
  metaTitle       String?
  metaDescription String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  createdById     String?
  updatedById     String?
  image           Image?       @relation(fields: [imageId], references: [id])

  @@index([slug])
  @@index([isActive, publishedAt])
  @@index([status])
  @@index([category])
  @@index([imageId], map: "StrategicPlan_imageId_fkey")
}

model FAQ {
  id         String   @id @default(cuid())
  question   String
  answer     String   @db.Text
  category   String?
  order      Int      @default(0)
  isActive   Boolean  @default(true)
  isSticky   Boolean  @default(false)
  questionAr String?
  answerAr   String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([isActive, order])
  @@index([category])
  @@index([isSticky])
}

model Innovator {
  id                 String                 @id @default(cuid())
  name               String
  email              String
  phone              String
  projectTitle       String
  projectDescription String?                @db.Text
  objective          String?                @db.Text
  stageDevelopment   StageDevelopment
  status             RecordStatus           @default(PENDING)
  isVisible          Boolean                @default(false)
  imageId            String?
  location           String?
  educationLevel     String?
  fieldOfStudy       String?
  workExperience     String?                @db.Text
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  reviewedAt         DateTime?
  reviewedById       String?
  city               String?
  country            String?
  image              Image?                 @relation(fields: [imageId], references: [id])
  projectFiles       InnovatorProjectFile[]

  @@index([status])
  @@index([isVisible])
  @@index([stageDevelopment])
  @@index([createdAt])
  @@index([email])
  @@index([imageId], map: "Innovator_imageId_fkey")
}

model Collaborator {
  id                         String                       @id @default(cuid())
  companyName                String
  primaryPhoneNumber         String
  optionalPhoneNumber        String?
  email                      String
  location                   String?
  website                    String?
  industrialSector           String
  specialization             String
  experienceProvided         String?                      @db.Text
  machineryAndEquipment      String?                      @db.Text
  status                     RecordStatus                 @default(PENDING)
  isVisible                  Boolean                      @default(false)
  imageId                    String?
  establishedYear            Int?
  employeeCount              String?
  annualRevenue              String?
  certifications             String?                      @db.Text
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  reviewedAt                 DateTime?
  reviewedById               String?
  site                       String?
  image                      Image?                       @relation(fields: [imageId], references: [id])
  experienceProvidedMedia    ExperienceProvidedMedia[]
  machineryAndEquipmentMedia MachineryAndEquipmentMedia[]

  @@index([status])
  @@index([isVisible])
  @@index([industrialSector])
  @@index([createdAt])
  @@index([email])
  @@index([imageId], map: "Collaborator_imageId_fkey")
}

model ExperienceProvidedMedia {
  id             String        @id @default(cuid())
  collaboratorId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  media          String
  collaborator   Collaborator? @relation(fields: [collaboratorId], references: [id])
  mediaRecord    Media         @relation(fields: [media], references: [id])

  @@index([collaboratorId])
  @@index([media])
}

model MachineryAndEquipmentMedia {
  id             String        @id @default(cuid())
  collaboratorId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  media          String
  collaborator   Collaborator? @relation(fields: [collaboratorId], references: [id])
  mediaRecord    Media         @relation(fields: [media], references: [id])

  @@index([collaboratorId])
  @@index([media])
}

model InnovatorProjectFile {
  id          String    @id @default(cuid())
  innovatorId String
  fileName    String
  fileType    String
  fileSize    Int
  mediaId     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  innovator   Innovator @relation(fields: [innovatorId], references: [id])
  media       Media     @relation(fields: [mediaId], references: [id])

  @@index([innovatorId])
  @@index([mediaId])
}

model AuditLog {
  id        String      @id @default(cuid())
  action    AuditAction
  tableName String
  recordId  String
  oldValues String?     @db.Text
  newValues String?     @db.Text
  userId    String?
  ipAddress String?
  userAgent String?     @db.Text
  createdAt DateTime    @default(now())
  user      User?       @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([tableName])
  @@index([userId])
  @@index([createdAt])
}

model EmailLog {
  id           String      @id @default(cuid())
  to           String
  from         String
  subject      String
  template     String
  status       EmailStatus
  messageId    String?
  errorMessage String?     @db.Text
  sentAt       DateTime?
  createdAt    DateTime    @default(now())

  @@index([to])
  @@index([status])
  @@index([createdAt])
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?  @db.Text
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model AdminNotification {
  id        String               @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String               @db.Text
  actionUrl String?
  priority  NotificationPriority @default(NORMAL)
  isRead    Boolean              @default(false)
  data      Json?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  readAt    DateTime?
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model PageContent {
  id        String   @id @default(cuid())
  page      String // "entrepreneurship" | "incubators"
  section   String // "hero" | "programs" | "values" | "mission" | "phases" | "resources" | "metrics" | "cta"
  titleEn   String?
  titleAr   String?
  contentEn String?  @db.Text
  contentAr String?  @db.Text
  icon      String? // Lucide icon name
  color     String? // gradient class
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  metadata  Json? // for extra fields like numberKey, labelKey, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([page, section, order])
  @@index([page, isActive])
  @@index([section])
}

model Report {
  id           String       @id @default(cuid())
  name         String
  type         ReportType
  format       ReportFormat @default(PDF)
  status       ReportStatus @default(PENDING)
  parameters   Json?
  fileUrl      String?
  generatedAt  DateTime?
  scheduleCron String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  createdById  String?

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([createdById])
}

enum StageDevelopment {
  STAGE
  PROTOTYPE
  DEVELOPMENT
  TESTING
  RELEASED
}

enum RecordStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
  UNDER_REVIEW
}

enum PlanPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum PlanStatus {
  DRAFT
  UNDER_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  APPROVE
  REJECT
  ARCHIVE
  LOGIN
  LOGOUT
}

enum EmailStatus {
  SENT
  FAILED
}

enum ReportType {
  SUBMISSIONS_SUMMARY
  USER_ACTIVITY
  STRATEGIC_PLANS
  FULL_PLATFORM
}

enum ReportFormat {
  PDF
  CSV
}

enum ReportStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}
